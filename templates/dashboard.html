{% extends "base.html" %}

{% block title %}Dashboard - Campus Complaint Portal{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Admin Dashboard</h2>
        <div class="text-sm text-gray-600">
            Last updated: <span id="lastUpdate">{{ stats.get('last_update', 'Just now') }}</span>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Total Complaints</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_complaints }}</p>
                </div>
                <div class="text-blue-500 text-4xl">üìù</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">High Severity</p>
                    <p class="text-3xl font-bold text-red-600">{{ stats.severity_stats.high }}</p>
                </div>
                <div class="text-red-500 text-4xl">‚ö†Ô∏è</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">Active Clusters</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.total_clusters }}</p>
                </div>
                <div class="text-green-500 text-4xl">üìä</div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600">This Week</p>
                    <p class="text-3xl font-bold text-gray-900">{{ stats.recent_complaints }}</p>
                </div>
                <div class="text-purple-500 text-4xl">üìà</div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Category Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Complaints by Category</h3>
            <canvas id="categoryChart"></canvas>
        </div>

        <!-- Severity Distribution -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-xl font-bold text-gray-900 mb-4">Severity Distribution</h3>
            <canvas id="severityChart"></canvas>
        </div>
    </div>

    <!-- Top Issue Clusters -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Top Issue Clusters</h3>
        
        {% if clusters %}
        <div class="space-y-3">
            {% for cluster in clusters[:10] %}
            <a href="{{ url_for('cluster_detail', cluster_id=cluster.id) }}" 
               class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">

                <div class="flex-1">
                    <p class="font-medium text-gray-900">{{ cluster.cluster_name }}</p>
                    <p class="text-sm text-gray-600">{{ cluster.category }}</p>
                </div>

                <div class="flex items-center space-x-4">

                    <!-- Severity -->
                    <span class="px-3 py-1 rounded-full text-xs font-medium
                        {% if cluster.severity == 'high' %}bg-red-100 text-red-800
                        {% elif cluster.severity == 'medium' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {{ cluster.severity.upper() }}
                    </span>

                    <!-- Complaint Count -->
                    <span class="text-lg font-bold text-gray-900">{{ cluster.count }}</span>
                    <span class="text-gray-400">üë•</span>

                    <!-- Total Cluster Upvotes -->
                    <span class="text-sm text-gray-700">
                        üëç {{ cluster.complaints | sum(attribute='upvotes') }} total upvotes
                    </span>

                </div>
            </a>
            {% endfor %}
        </div>

        {% else %}
        <p class="text-gray-600 text-center py-8">No clusters yet. Complaints will be grouped as they come in.</p>
        {% endif %}
    </div>

    <!-- Recent Complaints WITH Upvote Button (Option A) -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Recent Complaints</h3>
        
        {% if recent %}
        <div class="space-y-3">
            {% for complaint in recent %}
            <div class="p-4 bg-gray-50 rounded-lg">

                <!-- Header -->
                <div class="flex items-start justify-between mb-2">
                    <span class="text-sm font-medium text-gray-900">{{ complaint.category }}</span>

                    <span class="px-2 py-1 rounded text-xs font-medium
                        {% if complaint.severity == 'high' %}bg-red-100 text-red-800
                        {% elif complaint.severity == 'medium' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {{ complaint.severity }}
                    </span>
                </div>

                <!-- Complaint Text -->
                <p class="text-sm text-gray-700 mb-2">
                    {{ complaint.rewritten_text[:200] }}
                    {% if complaint.rewritten_text|length > 200 %}...{% endif %}
                </p>

                <!-- Footer -->
                <div class="flex items-center justify-between text-xs text-gray-500">

                    <span>{{ complaint.timestamp.strftime('%b %d, %Y at %I:%M %p') }}</span>

                    <span>
                        {% if complaint.student_id %}
                            ID: {{ complaint.student_id[:3] }}***
                        {% else %}
                            Anonymous
                        {% endif %}
                    </span>
                </div>

                <!-- Upvote Button ONLY -->
                <div class="flex items-center justify-end mt-3">
                    <button 
                        class="text-blue-600 hover:text-blue-800 text-xs font-medium flex items-center space-x-1"
                        onclick="upvote({{ complaint.id }})"
                    >
                        <span>üëç</span>
                        <span>Upvote ({{ complaint.upvotes }})</span>
                    </button>
                </div>

            </div>
            {% endfor %}
        </div>

        {% else %}
        <p class="text-gray-600 text-center py-8">No complaints yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Category Chart
const categoryCtx = document.getElementById('categoryChart').getContext('2d');
const categoryData = {{ stats.category_stats | tojson }};
const categoryChart = new Chart(categoryCtx, {
    type: 'doughnut',
    data: {
        labels: Object.keys(categoryData),
        datasets: [{
            data: Object.values(categoryData),
            backgroundColor: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#6366F1']
        }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

// Severity Chart
const severityCtx = document.getElementById('severityChart').getContext('2d');
const severityData = {{ stats.severity_stats | tojson }};
const severityChart = new Chart(severityCtx, {
    type: 'bar',
    data: {
        labels: ['High', 'Medium', 'Low'],
        datasets: [{
            label: 'Number of Complaints',
            data: [severityData.high, severityData.medium, severityData.low],
            backgroundColor: ['#EF4444', '#F59E0B', '#10B981']
        }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
});
</script>
{% endblock %}

